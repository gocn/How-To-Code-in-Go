<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="用 ldflags 设置 Go 应用程序的版本信息 # 简介 # 当把应用程序部署到生产环境中时，用版本信息和其他元数据构建二进制文件将改善你的监控、日志和调试过程，增加识别信息来帮助跟踪随着时间推移后，应用程序的构建信息。这种版本信息通常包括高度动态的数据，如构建时间、构建二进制文件的机器或用户、版本控制系统（VCS）的提交 ID，等其他更多信息。因为这些值是不断变化的，将这些数据直接编码到源代码中，并在每次新的构建之前进行修改，是很繁琐的，而且容易出错：源文件可能会移动，变量/常量在整个开发过程中可能会随着切换文件而改动，打断构建过程。
在 Go 中解决这个问题的一个方法是在使用go build命令时加上-ldflags，在构建时将动态信息插入二进制文件中，而不需要修改源代码。在这个标志中，ld代表linker，这个程序将编译后的源代码的不同部分连接成最终的二进制文件。ldflags就代表linker 的标志。之所以这样说，是因为它向底层的 Go 工具链 linkercmd/link传递了一个标志，允许你在构建时从命令行中改变导入的包的值。
在本教程中，你将使用-ldflags在构建时改变变量的值，并将你自己的动态信息加入二进制，用一个将版本信息打印到屏幕上的应用程序作为示例应用程序。
前期准备 # 为了接下去在文章中的例子，你需要：
按照如何安装 Go 和设置本地编程环境设置 Go 的 workspace。 构建你的范例应用程序 # 在使用ldflags加入动态数据之前，你首先需要一个应用程序来插入信息。在这一步，你将制作这个应用程序，在这个阶段，它将只打印静态的版本信息。现在让我们来创建这个应用程序。
在你的src目录下，建立一个以你的应用程序命名的目录。本教程将使用叫app的应用程序：
mkdir app 跳转你的目录到这个文件夹：
cd app 然后，使用你喜欢的文本编辑器，在main.go创建你的程序的 entry point：
nano main.go 现在，通过加入如下内容到你的程序内，来打印出版本信息：
package main import ( &#34;fmt&#34; ) var Version = &#34;development&#34; func main() { fmt.Println(&#34;Version:\t&#34;, Version) } 在main()函数内，你宣告了Version变量，然后打印string类型的Version：紧跟着 tab 的字符，\t，然后是声明的变量。
现在，参数Version被定义为development，将作为 app 的默认版本。稍后，你将会修改这个值来符合官方版本编号，根据semantic versioning format来定义。
保存并退出该文件。完成后，构建并运行该应用程序，来确认它打印的是正确的版本：
go build ."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content><meta property="og:description" content="用 ldflags 设置 Go 应用程序的版本信息 # 简介 # 当把应用程序部署到生产环境中时，用版本信息和其他元数据构建二进制文件将改善你的监控、日志和调试过程，增加识别信息来帮助跟踪随着时间推移后，应用程序的构建信息。这种版本信息通常包括高度动态的数据，如构建时间、构建二进制文件的机器或用户、版本控制系统（VCS）的提交 ID，等其他更多信息。因为这些值是不断变化的，将这些数据直接编码到源代码中，并在每次新的构建之前进行修改，是很繁琐的，而且容易出错：源文件可能会移动，变量/常量在整个开发过程中可能会随着切换文件而改动，打断构建过程。
在 Go 中解决这个问题的一个方法是在使用go build命令时加上-ldflags，在构建时将动态信息插入二进制文件中，而不需要修改源代码。在这个标志中，ld代表linker，这个程序将编译后的源代码的不同部分连接成最终的二进制文件。ldflags就代表linker 的标志。之所以这样说，是因为它向底层的 Go 工具链 linkercmd/link传递了一个标志，允许你在构建时从命令行中改变导入的包的值。
在本教程中，你将使用-ldflags在构建时改变变量的值，并将你自己的动态信息加入二进制，用一个将版本信息打印到屏幕上的应用程序作为示例应用程序。
前期准备 # 为了接下去在文章中的例子，你需要：
按照如何安装 Go 和设置本地编程环境设置 Go 的 workspace。 构建你的范例应用程序 # 在使用ldflags加入动态数据之前，你首先需要一个应用程序来插入信息。在这一步，你将制作这个应用程序，在这个阶段，它将只打印静态的版本信息。现在让我们来创建这个应用程序。
在你的src目录下，建立一个以你的应用程序命名的目录。本教程将使用叫app的应用程序：
mkdir app 跳转你的目录到这个文件夹：
cd app 然后，使用你喜欢的文本编辑器，在main.go创建你的程序的 entry point：
nano main.go 现在，通过加入如下内容到你的程序内，来打印出版本信息：
package main import ( &#34;fmt&#34; ) var Version = &#34;development&#34; func main() { fmt.Println(&#34;Version:\t&#34;, Version) } 在main()函数内，你宣告了Version变量，然后打印string类型的Version：紧跟着 tab 的字符，\t，然后是声明的变量。
现在，参数Version被定义为development，将作为 app 的默认版本。稍后，你将会修改这个值来符合官方版本编号，根据semantic versioning format来定义。
保存并退出该文件。完成后，构建并运行该应用程序，来确认它打印的是正确的版本：
go build ."><meta property="og:type" content="article"><meta property="og:url" content="https://gocn.github.io/How-To-Code-in-Go/docs/39-Using_ldflags_to_Set_Version_Information_for_Go_Applications/"><meta property="article:section" content="docs"><title>39 Using Ldflags to Set Version Information for Go Applications | How To Code in Go</title><link rel=manifest href=/How-To-Code-in-Go/manifest.json><link rel=icon href=/How-To-Code-in-Go/favicon.png type=image/x-icon><link rel=stylesheet href=/How-To-Code-in-Go/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/How-To-Code-in-Go/flexsearch.min.js></script>
<script defer src=/How-To-Code-in-Go/zh.search.min.2ccdafc211784f64f63652981924d269b4ff643413814bfc0d5743573b76ade7.js integrity="sha256-LM2vwhF4T2T2NlKYGSTSabT/ZDQTgUv8DVdDVzt2rec=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/How-To-Code-in-Go/><span>How To Code in Go</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><p><strong>开始学习</strong></p><ul><li><a href=/How-To-Code-in-Go/docs/01-How_To_Install_Go_and_Set_Up_a_Local-Programming_Environment_on_Ubuntu_18.04_DigitalOcean/>1. 如何在 Ubuntu 18.04 上安装 Go 和设置本地编程环境</a></li><li><a href=/How-To-Code-in-Go/docs/02-How_To_Install_Go_and_Set_Up_a_Local_Programming_Environment_on_macOS_DigitalOcean/>2. 如何在 macOS 上安装 Go 和设置本地编程环境</a></li><li><a href=/How-To-Code-in-Go/docs/03-How_To_Install_Go_and_Set_Up_a_Local_Programming_Environment_on_Windows_10_DigitalOcean/>3. 如何在 Windows 10 上安装 Go 和设置本地编程环境</a></li><li><a href=/How-To-Code-in-Go/docs/04-How_To_Write_Your_First_Program_in_Go_DigitalOcean/>4. 如何用 Go 编写你的第一个程序</a></li><li><a href=/How-To-Code-in-Go/docs/05-Understanding_the_GOPATH/>5. 理解 GOPATH</a></li><li><a href=/How-To-Code-in-Go/docs/06-How_To_Write_Comments_in_Go/>6. 如何在 Go 中写注释</a></li><li><a href=/How-To-Code-in-Go/docs/07-Understanding_Data_Types_in_Go/>7. 理解 Go 的数据类型</a></li><li><a href=/How-To-Code-in-Go/docs/08-An_Introduction_to_Working_with_Strings_in_Go/>8. Go 中处理字符串的介绍</a></li><li><a href=/How-To-Code-in-Go/docs/09-How_To_Format_Strings_in_Go/>9. 如何在 Go 中格式化字符串</a></li><li><a href=/How-To-Code-in-Go/docs/10-An_Introduction_to_the_Strings_Package_in_Go/>10. 介绍 Go 中的 Strings 包</a></li><li><a href=/How-To-Code-in-Go/docs/11-How_To_Use_Variables_and_Constants_in_Go/>11. 如何在 Go 中使用变量和常量</a></li><li><a href=/How-To-Code-in-Go/docs/12-How_To_Convert_Data_Types_in_Go/>12. 如何在 Go 中转换数据类型</a></li><li><a href=/How-To-Code-in-Go/docs/13-How_To_Do_Math_in_Go_with_Operators/>13. 如何用运算符在 Go 中做数学计算</a></li><li><a href=/How-To-Code-in-Go/docs/14-Understanding_Boolean_Logic_in_Go/>14. 理解 Go 中的布尔逻辑</a></li><li><a href=/How-To-Code-in-Go/docs/15-Understanding_Maps_in_Go/>15. 理解 Go 中的 Map</a></li><li><a href=/How-To-Code-in-Go/docs/16-Understanding_Arrays_and_Slices_in_Go/>16. 理解 Go 中的数组和切片</a></li><li><a href=/How-To-Code-in-Go/docs/17-Handling_Errors_in_Go_DigitalOcean/>17. 在 Go 中处理错误</a></li><li><a href=/How-To-Code-in-Go/docs/18-Creating_Custom_Errors_in_Go_DigitalOcean/>18. 在 Go 中创建自定义错误</a></li><li><a href=/How-To-Code-in-Go/docs/19-Handling_Panics_in_Go-_DigitalOcean/>19 在 Go 中处理恐慌</a></li><li><a href=/How-To-Code-in-Go/docs/20-Importing_Packages_in_Go_DigitalOcean/>20. 在 Go 中导入包</a></li><li><a href=/How-To-Code-in-Go/docs/21-How_To_Write_Packages_in_Go/>21. 如何在 Go 中编写包</a></li><li><a href=/How-To-Code-in-Go/docs/22-Understanding_Package_Visibility_in_Go/>22. 理解 Go 中包的可见性</a></li><li><a href=/How-To-Code-in-Go/docs/23-How_To_Write_Conditional_Statements_in_Go/>23. 如何在 Go 中编写条件语句</a></li><li><a href=/How-To-Code-in-Go/docs/24-How_To_Write_Switch_Statements_in_Go/>24. 如何在 Go 中编写 Switch 语句</a></li><li><a href=/How-To-Code-in-Go/docs/25-How_To_Construct_For_Loops_in_Go/>25. 如何在 Go 中构造 for 循环</a></li><li><a href=/How-To-Code-in-Go/docs/26-Using_Break_and_Continue_Statements_When_Working_with_Loops_in_Go/>26. 在循环中使用 Break 和 Continue</a></li><li><a href=/How-To-Code-in-Go/docs/27-How_To_Define_and_Call_Functions_in_Go/>27. 如何在 Go 中定义并调用函数</a></li><li><a href=/How-To-Code-in-Go/docs/28-How_To_Use_Variadic_Functions_in_Go/>28. 如何在 Go 中使用可变参数函数</a></li><li><a href=/How-To-Code-in-Go/docs/29-Understanding_defer_in_Go/>29. 理解 Go 中的 defer</a></li><li><a href=/How-To-Code-in-Go/docs/30-Understanding_init_in_Go/>30. 理解 Go 中的 init</a></li><li><a href=/How-To-Code-in-Go/docs/31-Customizing_Go_Binaries_with_Build_Tags/>31. 用构建标签定制 Go 二进制文件</a></li><li><a href=/How-To-Code-in-Go/docs/32-Understanding_Pointers_in_Go/>32. 理解 Go 中的指针</a></li><li><a href=/How-To-Code-in-Go/docs/33-Defining_Structs_in_Go/>33. 在 Go 中定义结构体</a></li><li><a href=/How-To-Code-in-Go/docs/34-Defining_Methods_in_Go/>34. 在 Go 中定义方法</a></li><li><a href=/How-To-Code-in-Go/docs/35-How_To_Build_and_Install_Go_Programs/>35. 如何构建和安装 Go 程序</a></li><li><a href=/How-To-Code-in-Go/docs/36-How_To_Use_Struct_Tags_in_Go/>36. 如何在 Go 中使用结构体标签</a></li><li><a href=/How-To-Code-in-Go/docs/37-How_To_Use_Interfaces_in_Go/>37. 如何在 Go 使用 interface</a></li><li><a href=/How-To-Code-in-Go/docs/38-Building_Go_Applications_for_Different_Operating_Systems_and_Architectures/>38. 在不同的操作系统和架构编译 Go 应用</a></li><li><a href=/How-To-Code-in-Go/docs/39-Using_ldflags_to_Set_Version_Information_for_Go_Applications/ class=active>39. 用 ldflags 设置 Go 应用程序的版本信息</a></li><li><a href=/How-To-Code-in-Go/docs/40-How_To_Use_the_Flag_Package_in_Go/>40. 在 Go 里面如何使用 Flag 包</a></li><li><a href=/How-To-Code-in-Go/docs/41-How_to_Use_Go_Modules/>41. 如何使用 Go 模块</a></li><li><a href=/How-To-Code-in-Go/docs/42-How_to_Distribute_Go_Modules/>42. 如何分发 Go 模块</a></li><li><a href=/How-To-Code-in-Go/docs/43-How_to_Use_a_Private_Go_Module_in_Your_Own_Project/>43. 如何在自己的项目中使用私有的Go模块</a></li></ul></li><li><p><strong>附录：资源</strong></p></li><li><p><a href=https://github.com/gocn/How-To-Code-in-Go><strong>Fork on Github</strong></a></p></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/How-To-Code-in-Go/svg/menu.svg class=book-icon alt=Menu></label>
<strong>39 Using Ldflags to Set Version Information for Go Applications</strong>
<label for=toc-control><img src=/How-To-Code-in-Go/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#前期准备>前期准备</a></li><li><a href=#构建你的范例应用程序>构建你的范例应用程序</a></li><li><a href=#在-go-build中使用ldflags的方法>在 <code>go build</code>中使用<code>ldflags</code>的方法</a></li><li><a href=#锁定子包变量>锁定子包变量</a></li><li><a href=#总结>总结</a></li></ul></nav></aside></header><article class=markdown><h1 id=用-ldflags-设置-go-应用程序的版本信息>用 ldflags 设置 Go 应用程序的版本信息
<a class=anchor href=#%e7%94%a8-ldflags-%e8%ae%be%e7%bd%ae-go-%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e7%9a%84%e7%89%88%e6%9c%ac%e4%bf%a1%e6%81%af>#</a></h1><h2 id=简介>简介
<a class=anchor href=#%e7%ae%80%e4%bb%8b>#</a></h2><p>当把应用程序部署到生产环境中时，用版本信息和其他元数据构建二进制文件将改善你的监控、日志和调试过程，增加识别信息来帮助跟踪随着时间推移后，应用程序的构建信息。这种版本信息通常包括高度动态的数据，如构建时间、构建二进制文件的机器或用户、<a href=https://www.atlassian.com/git/tutorials/what-is-version-control>版本控制系统（VCS）</a>的提交 ID，等其他更多信息。因为这些值是不断变化的，将这些数据直接编码到源代码中，并在每次新的构建之前进行修改，是很繁琐的，而且容易出错：源文件可能会移动，<a href=/How-To-Code-in-Go/docs/11-How_To_Use_Variables_and_Constants_in_Go/>变量/常量</a>在整个开发过程中可能会随着切换文件而改动，打断构建过程。</p><p>在 Go 中解决这个问题的一个方法是在使用<code>go build</code>命令时加上<code>-ldflags</code>，在构建时将动态信息插入二进制文件中，而不需要修改源代码。在这个标志中，<code>ld</code>代表<a href=https://en.wikipedia.org/wiki/Linker_%28computing%29><em>linker</em></a>，这个程序将编译后的源代码的不同部分连接成最终的二进制文件。<code>ldflags</code>就代表<em>linker 的标志</em>。之所以这样说，是因为它向底层的 Go 工具链 linker<a href=https://golang.org/cmd/link><code>cmd/link</code></a>传递了一个标志，允许你在构建时从命令行中改变导入的包的值。</p><p>在本教程中，你将使用<code>-ldflags</code>在构建时改变变量的值，并将你自己的动态信息加入二进制，用一个将版本信息打印到屏幕上的应用程序作为示例应用程序。</p><h2 id=前期准备>前期准备
<a class=anchor href=#%e5%89%8d%e6%9c%9f%e5%87%86%e5%a4%87>#</a></h2><p>为了接下去在文章中的例子，你需要：</p><ul><li>按照<a href=/How-To-Code-in-Go/docs/01-How_To_Install_Go_and_Set_Up_a_Local-Programming_Environment_on_Ubuntu_18.04_DigitalOcean/>如何安装 Go 和设置本地编程环境</a>设置 Go 的 workspace。</li></ul><h2 id=构建你的范例应用程序>构建你的范例应用程序
<a class=anchor href=#%e6%9e%84%e5%bb%ba%e4%bd%a0%e7%9a%84%e8%8c%83%e4%be%8b%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f>#</a></h2><p>在使用<code>ldflags</code>加入动态数据之前，你首先需要一个应用程序来插入信息。在这一步，你将制作这个应用程序，在这个阶段，它将只打印静态的版本信息。现在让我们来创建这个应用程序。</p><p>在你的<code>src</code>目录下，建立一个以你的应用程序命名的目录。本教程将使用叫<code>app</code>的应用程序：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir app
</span></span></code></pre></div><p>跳转你的目录到这个文件夹：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd app
</span></span></code></pre></div><p>然后，使用你喜欢的文本编辑器，在<code>main.go</code>创建你的程序的 entry point：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano main.go
</span></span></code></pre></div><p>现在，通过加入如下内容到你的程序内，来打印出版本信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Version</span> = <span style=color:#e6db74>&#34;development&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Version:\t&#34;</span>, <span style=color:#a6e22e>Version</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在<code>main()</code>函数内，你宣告了<code>Version</code>变量，然后打印<a href=/How-To-Code-in-Go/docs/08-An_Introduction_to_Working_with_Strings_in_Go/>string</a>类型的<code>Version</code>：紧跟着 tab 的字符，<code>\t</code>，然后是声明的变量。</p><p>现在，参数<code>Version</code>被定义为<code>development</code>，将作为 app 的默认版本。稍后，你将会修改这个值来符合官方版本编号，根据<a href=https://semver.org/>semantic versioning format</a>来定义。</p><p>保存并退出该文件。完成后，构建并运行该应用程序，来确认它打印的是正确的版本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build
</span></span><span style=display:flex><span>./app
</span></span></code></pre></div><p>你将会看到如下输出：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Output
</span></span><span style=display:flex><span>Version:	 development
</span></span></code></pre></div><p>你现在有一个打印默认版本信息的应用程序，但你还没有办法在构建时传入当前版本信息。在下一步，你将使用<code>-ldflags</code>和<code>go build</code>来解决这个问题。</p><h2 id=在-go-build中使用ldflags的方法>在 <code>go build</code>中使用<code>ldflags</code>的方法
<a class=anchor href=#%e5%9c%a8-go-build%e4%b8%ad%e4%bd%bf%e7%94%a8ldflags%e7%9a%84%e6%96%b9%e6%b3%95>#</a></h2><p>在前面提到的，<code>ldflags</code>代表<em>linker 标志</em>，用于向 Go 工具链中的底层 linker 传递标志。这是按以下语法进行的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build -ldflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-flag&#34;</span>
</span></span></code></pre></div><p>在这个例子中，我们向作为<code>go build</code>的一部分运行的<code>go tool link</code>命令传递了<code>flag</code>。这个命令在传递给<code>ldflags</code>的内容周围使用双引号，以避免其中字符串被分开，或者被命令行翻译为与我们想要的不同的字符。从这里，你可以传入<a href=https://golang.org/cmd/link/>许多不同的<code>linker</code>标志</a>。为了本教程中的目的，我们将使用<code>-X</code>标志在链接时将信息写入变量，跟着的是参数的<a href=/How-To-Code-in-Go/docs/20-Importing_Packages_in_Go_DigitalOcean/>package</a>路径和它的新值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build -ldflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-X &#39;package_path.variable_name=new_value&#39;&#34;</span>
</span></span></code></pre></div><p>在引号内，现在有<code>X</code>选项和一个<a href=https://gocn.github.io/How-To-Code-in-Go/docs/15-Understanding_Maps_in_Go/#%E9%94%AE%E5%92%8C%E5%80%BC>键值对</a>，代表要改变的变量和它的新值。<code>.</code>字符将包路径和变量名称分开，单引号用于避免键值对被断开。</p><p>要在你的示例程序中替换<code>Version</code>变量，使用最后一个命令块中的语法，传入一个新的值并建立新的二进制。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build -ldflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-X &#39;main.Version=v1.0.0&#39;&#34;</span>
</span></span></code></pre></div><p>在这个命令中，<code>main</code>是<code>Version</code>变量的包路径，因为这个变量在<code>main.go</code>文件中。<code>Version</code>是你要写入的变量，<code>v1.0.0</code>是新的值。</p><p>为了使用<code>ldflags</code>，你想改变的值必须存在，并且是一个<code>string</code>类型的包级变量。这个变量可以是对外导出的也可以不是。变量的值不可以是<code>const</code>或者是需要通过调用函数后得到的结果赋值的。幸运的是，<code>Version</code>满足了所有的要求：它已经在<code>main.go</code>文件中被声明为一个变量，而且当前值(<code>development</code>)和期望值(<code>v1.0.0</code>)都是字符串。</p><p>一旦你的新<code>app</code>二进制文件构建起来，运行应用程序：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./app
</span></span></code></pre></div><p>你将会收到如下输出：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Output
</span></span><span style=display:flex><span>Version:	 v1.0.0
</span></span></code></pre></div><p>通过<code>-ldflags</code>，你成功地把<code>Version</code>变量的值从<code>development</code>改成<code>v1.0.0</code>。</p><p>现在你已经在一个简单的应用程序构建时修改了一个<code>string</code>变量。使用<code>ldflags</code>，你可以在二进制文件中嵌入版本细节、许可信息等，只需使用命令行就可以发布。</p><p>在这个例子中，你改变的变量在<code>main</code>程序中，减少了确定路径名称的难度。但有时这些变量的路径寻找起来比较复杂。在下一步中，你将给子包中的变量赋值，来阐述确定更复杂的包路径的最佳方法。</p><h2 id=锁定子包变量>锁定子包变量
<a class=anchor href=#%e9%94%81%e5%ae%9a%e5%ad%90%e5%8c%85%e5%8f%98%e9%87%8f>#</a></h2><p>在上一节中，你操作了<code>Version</code>变量，它位于应用程序的顶层包。但这不是常见的案例。通常情况下，将这些变量放在另一个包中更为实际，因为<code>main</code>不是一个可导入的包。为了在你的示例程序中模拟这一点，你将创建一个新的子包，<code>app/build</code>，它将存储关于二进制文件被构建的时间和发出构建命令的用户名称的信息。</p><p>要添加一个新的子包，首先在你的项目中添加一个名为`build&rsquo;的新目录：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p build
</span></span></code></pre></div><p>然后创建一个名为<code>build.go</code>的新文件来保存新的变量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano build/build.go
</span></span></code></pre></div><p>在你的文本编辑器中，添加<code>Time</code>和<code>User</code>这两个新变量</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>build</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Time</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>User</span> <span style=color:#66d9ef>string</span>
</span></span></code></pre></div><p><code>Time</code>变量将保存二进制文件建立的时间的字符串表示。<code>User</code>变量将保存构建二进制文件的用户名称。由于这两个变量总是有值，你不需要像对<code>Version</code>那样用默认值初始化这些变量。</p><p>保存并退出文件。</p><p>然后，打开<code>main.go</code>文件添加这些变量到你的应用程序中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano main.go
</span></span></code></pre></div><p>在<code>main.go</code>中，添加如下高亮代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;app/build&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Version</span> = <span style=color:#e6db74>&#34;development&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Version:\t&#34;</span>, <span style=color:#a6e22e>Version</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;build.Time:\t&#34;</span>, <span style=color:#a6e22e>build</span>.<span style=color:#a6e22e>Time</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;build.User:\t&#34;</span>, <span style=color:#a6e22e>build</span>.<span style=color:#a6e22e>User</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在这些代码里，你第一次引用<code>app/build</code>包，然后用打印<code>Version</code>的方式打印<code>build.Time</code>和<code>build.User</code>。</p><p>保存文件，然后从你的文本编辑器退出。</p><p>接下来，为了用<code>ldflags</code>锁定这些变量，你可以使用导入路径<code>app/build</code>，然后是<code>.User</code>或<code>.Time</code>，因为你已经知道导入的路径。 然而，为了模拟一种更复杂的情况，即不知道变量的导入路径，让我们改用 Go 工具链中的<code>nm</code>命令。</p><p><code>go tool nm</code>命令将输出在给定的可执行文件、对象文件或存档中涉及的符号。在这种情况下，符号指的是代码中的一个对象，例如一个定义的或导入的变量或函数。通过使用<code>nm</code>生成一个符号表，并使用<code>grep</code>搜索一个变量，你可以快速找到其路径信息。</p><p>注意：如果软件包名称中有任何非<a href=https://en.wikipedia.org/wiki/ASCII>ASCII</a>字符，或者有<code>"</code>或<code>%</code>字符，<code>nm</code>命令将不能帮助你找到变量的路径，因为这是工具本身的限制。</p><p>要使用这个命令，首先要为<code>app</code>构建二进制文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build
</span></span></code></pre></div><p>现在<code>app</code>已经构建好了，将<code>nm</code>工具指向它，并在输出中搜索：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go tool nm ./app | grep app
</span></span></code></pre></div><p>当运行时，<code>nm</code>工具将输出大量的数据。因为如此，前面的命令使用<code>|</code>将输出的数据输送给<code>grep</code>命令，然后搜索标题中带有一级<code>app</code>的数据。</p><p>你将会收到类似如下的输出：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Output  
</span></span><span style=display:flex><span>  55d2c0 D app/build.Time
</span></span><span style=display:flex><span>  55d2d0 D app/build.User
</span></span><span style=display:flex><span>  4069a0 T runtime.appendIntStr
</span></span><span style=display:flex><span>  462580 T strconv.appendEscapedRune
</span></span><span style=display:flex><span>. . .
</span></span></code></pre></div><p>在这种情况下，结果集的前两行包含你要找的两个变量的路径。<code>app/build.Time</code>和<code>app/build.User</code>。</p><p>现在你知道了路径，再次构建应用程序，这次在构建时改变<code>版本</code>、<code>用户</code>和<code>时间</code>。要做到这一点，需要向<code>-ldflags</code>传递多个<code>-X</code>标志：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build -v -ldflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-X &#39;main.Version=v1.0.0&#39; -X &#39;app/build.User=</span><span style=color:#66d9ef>$(</span>id -u -n<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#39; -X &#39;app/build.Time=</span><span style=color:#66d9ef>$(</span>date<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#39;&#34;</span>
</span></span></code></pre></div><p>这里你传入了<code>id -u -n</code> Bash 命令来列出当前用户，以及<code>date</code>命令来列出当前日期。</p><p>构建好了可执行文件，运行该程序：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./app
</span></span></code></pre></div><p>该命令在 Unix 系统上运行时，将产生与下面类似的输出：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Output
</span></span><span style=display:flex><span>Version:	 v1.0.0
</span></span><span style=display:flex><span>build.Time:	 Fri Oct  4 19:49:19 UTC 2019
</span></span><span style=display:flex><span>build.User:	 sammy
</span></span></code></pre></div><p>现在你有一个包含版本和构建信息的二进制文件，在生产中解决问题时可以提供重要帮助。</p><h2 id=总结>总结
<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h2><p>这个教程展示了，如果应用得当，<code>ldflags</code>可以成为一个强大的工具，在构建时向二进制文件注入有价值的信息。这样，你可以控制功能标志、环境信息、版本信息等等，而不需要对你的源代码进行修改。通过添加<code>ldflags</code>到你当前的构建工作流程中，你可以最大限度地发挥 Go 自成一体的二进制的发布格式的优势。</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#前期准备>前期准备</a></li><li><a href=#构建你的范例应用程序>构建你的范例应用程序</a></li><li><a href=#在-go-build中使用ldflags的方法>在 <code>go build</code>中使用<code>ldflags</code>的方法</a></li><li><a href=#锁定子包变量>锁定子包变量</a></li><li><a href=#总结>总结</a></li></ul></nav></div></aside></main></body></html>